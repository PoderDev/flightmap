@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer
@page "/"

<PageTitle>Home</PageTitle>

<div id="map" class="w-100 h-100"></div>

@code {
    private IJSObjectReference? module;
    private string? result;
    private double latitude = 59.34973;
    private double longitude = 16.70488;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./leafletmap.js");
            if (module is not null)
            {
                result = await module.InvokeAsync<string>("load_map");
            }
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (module is not null)
        {
            await module.DisposeAsync();
        }
    }

    protected override void OnInitialized()
    {
        var timer = new Timer(new TimerCallback(_ =>
         {
             InvokeAsync(async () =>
             {
                 if (module is not null)
                 {
                     latitude += 0.001;
                     longitude += 0.001;
                     if (latitude > 59.36973)
                     {
                         latitude = 59.32973;
                         longitude = 16.68488;
                     }
                         
                     result = await module.InvokeAsync<string>("update_position", latitude, longitude);
                 }
             });
         }), null, 1000, 1000);
    }
}